<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Видео Редактор</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 10px;
            margin: 0;
            overflow-x: hidden;
        }
        h1 {
            text-align: center;
            font-size: 24px;
        }
        video {
            width: 100%;
            height: auto;
            margin-bottom: 10px;
        }
        .controls {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        label {
            font-size: 14px;
        }
        input[type="range"] {
            width: 100%;
        }
        .buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }
        button {
            padding: 10px 15px;
            font-size: 16px;
            flex: none;
        }
        .playback-rate-input {
            width: 100%;
        }
    </style>
</head>
<body>

    <h1>Видео Редактор</h1>

    <input type="file" id="videoUpload" accept="video/*"><br>

    <video id="video" controls></video><br>

    <div class="controls">
        <div>
            <label>Обрезка видео:</label>
            <input type="range" id="trimStart" value="0" step="0.1" min="0">
            <input type="range" id="trimEnd" value="0" step="0.1" min="0">
        </div>

        <div>
            <label>Скорость воспроизведения (0.1x - 10x):</label>
            <input type="number" id="playbackRate" class="playback-rate-input" value="1" step="0.1" min="0.1" max="10">
        </div>

        <div class="buttons">
            <button id="applyChanges">Применить изменения</button>
            <button id="fullscreen">На весь экран</button>
            <button id="downloadVideo">Скачать видео</button>
        </div>
    </div>

    <script>
        const videoUpload = document.getElementById('videoUpload');
        const video = document.getElementById('video');
        const trimStart = document.getElementById('trimStart');
        const trimEnd = document.getElementById('trimEnd');
        const playbackRateInput = document.getElementById('playbackRate');
        const applyChangesButton = document.getElementById('applyChanges');
        const downloadVideoButton = document.getElementById('downloadVideo');
        const fullscreenButton = document.getElementById('fullscreen');

        let videoFile;

        videoUpload.addEventListener('change', function() {
            videoFile = this.files[0];
            if (videoFile) {
                const url = URL.createObjectURL(videoFile);
                video.src = url;
                video.load();
                video.onloadedmetadata = function() {
                    trimStart.max = video.duration;
                    trimEnd.max = video.duration;
                    trimEnd.value = video.duration;
                };
            }
        });

        applyChangesButton.addEventListener('click', function() {
            const startTime = parseFloat(trimStart.value);
            const endTime = parseFloat(trimEnd.value);
            let playbackRate = parseFloat(playbackRateInput.value);

            if (playbackRate < 0.1) playbackRate = 0.1;
            if (playbackRate > 10) playbackRate = 10;

            video.currentTime = startTime;
            video.playbackRate = playbackRate;

            video.ontimeupdate = function() {
                if (video.currentTime >= endTime) {
                    video.pause();
                }
            };
            video.play();
        });

        fullscreenButton.addEventListener('click', function() {
            if (video.requestFullscreen) {
                video.requestFullscreen();
            } else if (video.webkitRequestFullscreen) { /* Safari */
                video.webkitRequestFullscreen();
            } else if (video.msRequestFullscreen) { /* IE11 */
                video.msRequestFullscreen();
            }
        });

        downloadVideoButton.addEventListener('click', async function() {
            if (!videoFile) return alert('Сначала загрузите видео.');

            alert('Начинается обработка видео. Это может занять некоторое время.');

            if (typeof FFmpeg === 'undefined') {
                return alert('Извините, ваш браузер не поддерживает необходимые функции для обработки видео.');
            }

            const { createFFmpeg, fetchFile } = FFmpeg;
            const ffmpeg = createFFmpeg({ log: true });

            await ffmpeg.load();

            const startTime = parseFloat(trimStart.value);
            const duration = parseFloat(trimEnd.value) - startTime;
            let playbackRate = parseFloat(playbackRateInput.value);

            if (playbackRate < 0.1) playbackRate = 0.1;
            if (playbackRate > 10) playbackRate = 10;

            ffmpeg.FS('writeFile', 'input.mp4', await fetchFile(videoFile));

            await ffmpeg.run(
                '-i', 'input.mp4',
                '-ss', `${startTime}`,
                '-t', `${duration}`,
                '-filter_complex', `[0:v]setpts=${1/playbackRate}*PTS[v];[0:a]atempo=${playbackRate}[a]`,
                '-map', '[v]',
                '-map', '[a]',
                'output.mp4'
            );

            const data = ffmpeg.FS('readFile', 'output.mp4');

            const blob = new Blob([data.buffer], { type: 'video/mp4' });
            const url = URL.createObjectURL(blob);

            const a = document.createElement('a');
            a.href = url;
            a.download = 'edited_video.mp4';
            a.click();

            URL.revokeObjectURL(url);
        });
    </script>

    <!-- Подключение FFmpeg.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ffmpeg.js/0.10.1/ffmpeg.min.js"></script>

</body>
</html>